from flask import Flask, request, jsonify
from dotenv import load_dotenv
import os

load_dotenv()  # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

from flask_cors import CORS
from gigachat import GigaChat
import time

app = Flask(__name__)
CORS(app)  # –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã –æ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

API_KEY = os.getenv("API_KEY")  # –ü–æ–ª—É—á–∞–µ–º API_KEY –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è

def find_answer(user_message):
    # –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ —Å –±–æ–ª–µ–µ –ª–æ—è–ª—å–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏
    knowledge_base = {
        "–≥–∞—Ä–∞–Ω—Ç–∏—è": "–ö–æ–Ω–µ—á–Ω–æ! –ú—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –≥–∞—Ä–∞–Ω—Ç–∏—é –æ—Ç 3 –¥–æ 6 –º–µ—Å—è—Ü–µ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞.",
        "–∑–∞–∫–∞–∑ —Å–µ–≥–æ–¥–Ω—è": "–î–∞, –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑ —Å–µ–≥–æ–¥–Ω—è –ø—Ä–∏ —Å–∞–º–æ–≤—ã–≤–æ–∑–µ –∏ –Ω–∞–ª–∏—á–∏–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ.",
        "–æ—Ä–∏–≥–∏–Ω–∞–ª": "–í—Å–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–∞–ø—á–∞—Å—Ç–∏ –∏–º–µ—é—Ç —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä Apple, —á—Ç–æ–±—ã –≤—ã –º–æ–≥–ª–∏ –±—ã—Ç—å —É–≤–µ—Ä–µ–Ω—ã –≤ –∏—Ö –∫–∞—á–µ—Å—Ç–≤–µ.",
        "–≤–æ–∑–≤—Ä–∞—Ç": "–î–∞, —É –Ω–∞—Å –µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 14 –¥–Ω–µ–π –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É–ø–∞–∫–æ–≤–∫–∏ –∏ —á–µ–∫–∞.",
        "–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞": "–ù–µ—Ç, –≤–∞–º –Ω–µ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—É. –û–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞.",
        "–¥–æ—Å—Ç–∞–≤–∫–∞": "–ú—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –¥–æ—Å—Ç–∞–≤–∫–∏: —Å–∞–º–æ–≤—ã–≤–æ–∑, –∫—É—Ä—å–µ—Ä—Å–∫–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ (1-2 –¥–Ω—è) –∏ –°–î–≠–ö (2-3 –¥–Ω—è)."
    }
    
    # –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –¥–ª—è –ø–æ–∏—Å–∫–∞
    user_message = user_message.lower()
    
    # –ü–æ–∏—Å–∫ –æ—Ç–≤–µ—Ç–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    for keyword, answer in knowledge_base.items():
        if keyword in user_message:
            return answer
    
    return "–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –Ω–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞—à–∏–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º!"

GREETING = """–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –í–∞—Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç MYTOOLSSHOP. 
–ú—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º—Å—è –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö –∑–∞–ø—á–∞—Å—Ç—è—Ö –¥–ª—è —Ç–µ—Ö–Ω–∏–∫–∏ Apple.
üïí –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ 9:00-21:00
üìû –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω: +7 (495) XXX-XX-XX
üìç –ê–¥—Ä–µ—Å —Å–∞–º–æ–≤—ã–≤–æ–∑–∞: –ú–æ—Å–∫–≤–∞, —É–ª. –ó–∞–ø—á–∞—Å—Ç–Ω–∞—è, 15 (–º–µ—Ç—Ä–æ "–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è")

–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"""

@app.route('/api/chat', methods=['POST'])
def chat():
    data = request.json
    user_message = data.get('message', '')
    
    # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    if user_message.lower() == "–ø—Ä–∏–≤–µ—Ç" or user_message.lower() == "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ":
        reply = GREETING
    else:
        # –ü–æ–∏—Å–∫ –æ—Ç–≤–µ—Ç–∞ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
        reply = find_answer(user_message)
    
    return jsonify({
        'success': True,
        'reply': reply
    })

if __name__ == '__main__':
    app.run(port=5000, debug=True)
